name: Supabase Heartbeat

# Her 2 gÃ¼nde bir Ã§alÄ±ÅŸÄ±r (Supabase free tier 7 gÃ¼nde pause olur, 2 gÃ¼nde bir gÃ¼venli)
# AyrÄ±ca manuel tetikleme de mÃ¼mkÃ¼n
on:
  schedule:
    # Her 2 gÃ¼nde bir saat 09:00'da (UTC) = TÃ¼rkiye 12:00
    # Cron: dakika saat gÃ¼n(ay) ay haftanÄ±n_gÃ¼nÃ¼
    - cron: "0 9 */2 * *"

  # Manuel tetikleme iÃ§in
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest

    steps:
      - name: Ping Heartbeat Endpoint
        env:
          # GitHub Secrets'tan URL al (Settings â†’ Secrets â†’ Actions â†’ New repository secret)
          # Secret adÄ±: HEARTBEAT_URL
          # DeÄŸer: https://salliusagikoop.vercel.app/api/heartbeat
          # EÄŸer secret yoksa fallback URL kullanÄ±r
          HEARTBEAT_URL: ${{ secrets.HEARTBEAT_URL || 'https://salliusagikoop.vercel.app/api/heartbeat' }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Supabase heartbeat baÅŸlatÄ±lÄ±yor..."
          echo "Zaman: $(date)"
          echo "URL: $HEARTBEAT_URL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Retry mekanizmasÄ±yla endpoint'i Ã§aÄŸÄ±r
          # --retry 3: Hata durumunda 3 kere daha dene
          # --retry-delay 5: Denemeler arasÄ± 5 saniye bekle
          # --retry-all-errors: TÃ¼m hata tiplerinde retry yap
          # --max-time 30: Maksimum 30 saniye timeout
          # --connect-timeout 10: BaÄŸlantÄ± iÃ§in 10 saniye timeout
          # -s: Sessiz mod (progress bar yok)
          # -w: HTTP status code'u ayrÄ± satÄ±rda yaz

          response=$(curl -s -w "\n%{http_code}" \
            --retry 3 \
            --retry-delay 5 \
            --retry-all-errors \
            --max-time 30 \
            --connect-timeout 10 \
            "$HEARTBEAT_URL")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š SonuÃ§:"
          echo "HTTP Status: $http_code"
          echo "Response Body:"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Heartbeat baÅŸarÄ±lÄ±!"
            exit 0
          else
            echo "âŒ Heartbeat baÅŸarÄ±sÄ±z! (HTTP $http_code)"
            echo "âš ï¸  3 deneme yapÄ±ldÄ± ancak baÅŸarÄ±sÄ±z oldu."
            exit 1
          fi

      - name: SonuÃ§
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Supabase projesi aktif tutuldu!"
          echo "â° Sonraki Ã§alÄ±ÅŸma: ~2 gÃ¼n sonra"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
